<h3 mat-dialog-title>{{ 'Edit task' | translate }}</h3>
<div [formGroup]="taskForm">
  <div mat-dialog-content>
    <mat-slide-toggle class="p-2"
                      color="accent"
                      id="updateTaskStatusToggle"
                      formControlName="taskStatus"
                      (change)="changeStatus($event.checked)">
      {{ 'Status' | translate }}
    </mat-slide-toggle>
    <div class="d-flex flex-row">
      <mat-form-field class="p-3">
        <mat-label>{{ 'Location' | translate }}</mat-label>
        <mtx-select
          [items]="properties"
          [bindValue]="'id'"
          [bindLabel]="'name'"
          id="updateProperty"
          formControlName="propertyId"
          (change)="changePropertyId($event)"
          [clearable]="false"
          [disabled]="true"
          [readonly]="true"
        />
      </mat-form-field>

      <mat-form-field class="p-3">
        <mat-label>{{ 'Report tag' | translate }}</mat-label>
        <mtx-select
          [items]="tags"
          [bindValue]="'id'"
          [bindLabel]="'name'"
          id="updateTableTags"
          formControlName="itemPlanningTagId"
          (change)="changePlanningTagId($event)"
          [clearable]="true"
          [multiple]="false"
        />
      </mat-form-field>
      <div class="pt-6">
        <button
          matSuffix
          mat-icon-button
          color="primary"
          id="planningManageTagsBtn1"
          (click)="openTagsModal()"
          matTooltip="{{ 'Manage tags' | translate }}"
        >
          <mat-icon>discount</mat-icon>
        </button>
      </div>
    </div>
    <div class="d-flex flex-row">
      <div style="width: 450px" class="p-2">
        <button
          mat-icon-button
          color="accent"
          id="updateFolder"
          (click)="openFoldersModal()"
          style="margin-left: -10px"
          [disabled]="
            !taskForm.get('propertyId')?.value ||
            taskForm.get('status')?.value === TaskWizardStatusesEnum.Active
          "
          [matTooltip]="
            (!taskForm.get('propertyId')?.value
              ? 'Need to select property'
              : 'Select folder') | translate
          "
        >
          <mat-icon>folder</mat-icon>
        </button>
        <span>{{ selectedFolderName || ('Folder not selected' | translate) }}</span>
      </div>
    </div>

    <div class="d-flex flex-row">
      <mat-form-field class="p-3">
        <mat-label>{{ 'Start from' | translate }}</mat-label>
        <input
          matInput
          [matDatepicker]="picker"
          formControlName="startDate"
          (dateChange)="updateStartDate($event)"
          (dateInput)="updateStartDate($event)"
          (click)="picker.open()"
          id="updateStartFrom"
          [disabled]="taskForm.get('status')?.value === TaskWizardStatusesEnum.Active || copyModel.status === TaskWizardStatusesEnum.Active"
        >
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>
      <mat-form-field class="p-3">
        <mat-label>{{ 'Tags' | translate }}</mat-label>
        <mtx-select
          [items]="tags"
          [bindValue]="'id'"
          [bindLabel]="'name'"
          id="updateTags"
          formControlName="tagIds"
          (change)="changeTagIds($event)"
          [clearable]="true"
          [multiple]="true"
        />
      </mat-form-field>
      <div class="pt-6">
        <button
          matSuffix
          mat-icon-button
          color="primary"
          id="planningManageTagsBtn2"
          (click)="openTagsModal()"
          matTooltip="{{ 'Manage tags' | translate }}"
        >
          <mat-icon>discount</mat-icon>
        </button>
      </div>
    </div>
    <div class="d-flex flex-row">
      <mat-form-field class="p-2">
        <mat-label>{{ 'Repeat type' | translate }}</mat-label>
        <mtx-select
          [items]="repeatTypeArr"
          [bindValue]="'id'"
          [bindLabel]="'name'"
          id="updateRepeatType"
          formControlName="repeatType"
          (change)="changeRepeatType($event.id ?? $event)"
          [clearable]="false"
          [multiple]="false"
          [readonly]="taskForm.get('status')?.value === TaskWizardStatusesEnum.Active || copyModel.status === TaskWizardStatusesEnum.Active"
        />
      </mat-form-field>
      <mat-form-field class="p-2" *ngIf="taskForm.get('repeatType')?.value !== 0">
        <mat-label>{{ 'Repeat every' | translate }}</mat-label>
        <mtx-select
          [items]="repeatTypeMass()"
          [bindValue]="'id'"
          [bindLabel]="'name'"
          id="updateRepeatEvery"
          formControlName="repeatEvery"
          (change)="changeRepeatEvery($event.id ?? $event)"
          [clearable]="false"
          [multiple]="false"
          [readonly]="taskForm.get('status')?.value === TaskWizardStatusesEnum.Active || copyModel.status === TaskWizardStatusesEnum.Active"
        />
      </mat-form-field>
    </div>
    <!--  <mat-form-field (click)="model.status === TaskWizardStatusesEnum.NotActive ? openFoldersModal() : null">
        <mat-label>{{ 'Folder' | translate }}</mat-label>
        <input
          matInput
          id="updateFolder"
          [ngModel]="selectedFolderName"
          [disabled]="true"
        >
      </mat-form-field>-->
    <div formArrayName="translates">
    <ng-container
      *ngFor="let translate of taskForm.get('translates')['controls']; let i = index"
      [formGroupName]="i"
    >
      <ng-container *ngIf="i % 2 === 0">
        <div class="d-flex flex-row">
          <mat-form-field class="p-2">
            <mat-label>{{ 'Task description' | translate }}  ({{ getLanguageName(translate.get('languageId')?.value) }})
            </mat-label>
            <input
              type="text"
              id="updateName{{i}}"
              matInput
              formControlName="name"
              [disabled]="taskForm.get('status')?.value === TaskWizardStatusesEnum.Active || copyModel.status === TaskWizardStatusesEnum.Active"
            >
          </mat-form-field>
          <mat-form-field *ngIf="taskForm.get('translates')['controls'][i + 1] as nextTranslate" class="p-2">
            <mat-label>{{ 'Task description' | translate }}  ({{ getLanguageName(nextTranslate.get('languageId')?.value) }})
            </mat-label>
            <input
              type="text"
              id="updateName{{i + 1}}"
              matInput
              [formControl]="nextTranslate.get('name')"
              [disabled]="taskForm.get('status')?.value === TaskWizardStatusesEnum.Active || copyModel.status === TaskWizardStatusesEnum.Active"
            >
          </mat-form-field>
        </div>
        <!--    <mat-card-->
        <!--      [class.mt-2]="!isFirst"-->
        <!--      [class.mb-2]="isLast">-->
        <!--      <mat-card-title>{{getLanguageName(languageModel.languageId)}}</mat-card-title>-->
        <!--      <mat-card-content>-->
        <!--        <mat-form-field>-->
        <!--          <mat-label>{{'Task description' | translate}}</mat-label>-->
        <!--          <input-->
        <!--            type="text"-->
        <!--            id="updateName{{i}}"-->
        <!--            matInput-->
        <!--            [ngModel]="languageModel.name"-->
        <!--            (ngModelChange)="updateName($event, i)"-->
        <!--            [disabled]="model.status === TaskWizardStatusesEnum.Active"-->
        <!--          >-->
        <!--        </mat-form-field>-->
        <!--      </mat-card-content>-->
        <!--    </mat-card>-->

        <!--<app-eform-translation
              [class.mt-2]="!isFirst"
              [class.mb-2]="isLast"
              [model]="languageModel"
              (modelChange)="updateLanguageModel($event, i)"
              [title]="getLanguageName(languageModel.languageId)"/>-->
      </ng-container>
    </ng-container>
    </div>
    <div class="d-flex flex-row">
      <mat-form-field class="p-2">
        <mat-label>{{ 'eForm template' | translate }}</mat-label>
        <mtx-select
          [items]="templatesModel.templates"
          [bindLabel]="'label'"
          [bindValue]="'id'"
          [typeahead]="typeahead"
          formControlName="eformId"
          (change)="updateEformId($event.id ?? $event)"
          id="updateTemplateSelector"
          [clearable]="false"
          [multiple]="false"
          [readonly]="taskForm.get('status')?.value === TaskWizardStatusesEnum.Active"
          [disabled]="taskForm.get('status')?.value === TaskWizardStatusesEnum.Active"
        ></mtx-select>
      </mat-form-field>
    </div>

    <div class="d-flex flex-row">
      <mtx-grid
        class="mb-2 p-2"
        [data]="sites"
        [columns]="tableHeaders"
        [cellTemplate]="{select: selectTpl}"
        [showPaginator]="false"
        [pageOnFront]="false"
        [rowStriped]="true"
        [showToolbar]="false"
        [showColumnMenuButton]="false"
      />
    </div>
    <ng-template #selectTpl let-row let-i="index">
      <mat-checkbox class="mat-checkbox"
                    id="checkboxUpdateAssignment{{ i }}"
                    (change)="addToArray($event, row.id)"
                    [checked]="getAssignmentBySiteId(row.id)"
                    [value]="getAssignmentBySiteId(row.id).toString()"/>
    </ng-template>
  </div>
  <div mat-dialog-actions class="d-flex flex-row justify-content-end">
    <button
      mat-raised-button
      color="accent"
      id="updateTaskBtn"
      (click)="update()"
      [disabled]="disabledSaveButton"
    >
      {{ 'Save' | translate }}
    </button>
    <button
      mat-raised-button
      id="cancelUpdateTaskBtn"
      (click)="hide()"
    >
      {{ 'Cancel' | translate }}
    </button>
  </div>
</div>
