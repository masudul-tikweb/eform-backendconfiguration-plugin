<mtx-grid
  [data]="sitesDto"
  [columns]="tableHeaders"
  [cellTemplate]="{
    siteId: deviceUserIdTpl,
    propertyNames: propertyNamesTpl,
    siteName: fullNameTpl,
    workerEmail: workerEmailTpl,
    phoneNumber: phoneNumberTpl,
    language: languageTpl,
    customerOtp: customerOtpTpl,
    manufacturer: manufacturerTpl,
    actions: actionsTpl,
    taskManagementEnabled: taskManagementEnabledTpl,
    timeRegistrationEnabled: timeRegistrationEnabledTpl,
    }"
  [showPaginator]="false"
  [pageOnFront]="false"
  [rowStriped]="true"
  [showToolbar]="true"
  [showColumnMenuButton]="false"
  [toolbarTemplate]="toolbarTpl"
  [sortActive]="selectPropertyWorkersPaginationSort$ | async"
  [sortDirection]="selectPropertyWorkersPaginationIsSortDsc$ | async"
  (sortChange)="onSortTable($event)"
  style="max-height: 80vh;"
  noResultText="{{'No employees found' | translate}}"
>
</mtx-grid>

<!-- (sortChange)="sortTable($event)" -->

<ng-template #toolbarTpl>
  <div class="d-flex flex-row justify-content-start flex-nowrap">
    <div class="d-flex flex-column mr-2 ml-2">
      <mat-form-field>
        <mat-label>{{ 'Search' | translate }}</mat-label>
        <input
          matInput
          type="text"
          (ngModelChange)="onSearchChanged($event)"
          [ngModel]="selectPropertyWorkersNameFilters$ | async"
          id="labelInput"
        />
      </mat-form-field>
    </div>
  </div>
</ng-template>

<ng-template #propertyNamesTpl let-row>
  <div class="d-flex flex-wrap">
    <mat-chip color="primary" *ngFor="let name of row.propertyNames">
      <span>{{name}}</span>
    </mat-chip>
  </div>
</ng-template>

<!--<ng-template #deviceUserIdTpl let-row let-i="index">-->
<!--  <div class="deviceUserId" id="deviceUserId-{{i}}">{{row.siteId}}</div>-->
<!--</ng-template>-->

<ng-template #deviceUserIdTpl let-row let-i="index">
  <div class="deviceUserId" id="deviceUserId-{{i}}">
    <ng-container *ngIf="selectAuthIsAdmin$ | async;">
      <span>{{row.siteId}}<small class="microting-uid"> ({{getFormattedDate(row.createdAt)}} / {{getFormattedDate(row.updatedAt)}})</small></span>
    </ng-container>
    <ng-container *ngIf="(selectAuthIsAdmin$ | async) !== true;">
      {{row.siteId}}
    </ng-container></div>
</ng-template>

<!--<ng-template #propertyNamesTpl let-row>-->
<!--  <div class="d-flex flex-column">-->
<!--    <div *ngFor="let bla of row.propertyNames">-->
<!--      <mat-chip color="primary">-->
<!--        <span>{{bla}}</span>-->
<!--      </mat-chip>-->
<!--    </div>-->
<!--  </div>-->
<!--</ng-template>-->

<ng-template #fullNameTpl let-row let-i="index">
  <div class="deviceUserFullName" id="deviceUserFullName-{{i}}">{{row.siteName}}</div>
</ng-template>

<ng-template #workerEmailTpl let-row let-i="index">
  <div class="workerEmail" id="workerEmail-{{i}}">{{row.workerEmail}}</div>
</ng-template>

<ng-template #phoneNumberTpl let-row let-i="index">
  <div class="phoneNumber" id="phoneNumber-{{i}}">{{row.phoneNumber}}</div>
</ng-template>

<ng-template #languageTpl let-row let-i="index">
  <div class="deviceUserLanguage" id="deviceUserLanguage-{{i}}">{{row.language | translate}}</div>
</ng-template>

<ng-template #customerOtpTpl let-row>
  <ng-container *ngIf="row.customerNo && row.otpCode">
    {{ row.customerNo }} / {{ row.otpCode }}
  </ng-container>
  <ng-container *ngIf="row.otpCode == 0">
    <button
      class="reportCaseUnarchive"
      mat-icon-button
      color="warn"
      *ngIf="selectCurrentUserClaimsDeviceUsersUpdate$ | async"
      matTooltip="{{ 'New OTP' | translate }}"
      (click)="openOtpModal(row)"
    >
      <mat-icon>key</mat-icon>
    </button>
  </ng-container>
  <ng-container *ngIf="!row.unitId"> N/A</ng-container>
</ng-template>

<!--<ng-template #propertyTpl let-row>-->
<!--  <div [innerHTML]="this.getWorkerPropertyNames(row.siteId)"></div>-->
<!--</ng-template>-->
<ng-template #actionsTpl let-row let-i="index">
  <div class="device-user-actions" id="device-user-actions-{{i}}">
    <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="{{ 'Actions' | translate }}">
      <mat-icon>more_vert</mat-icon>
    </button>

    <mat-menu #menu="matMenu">
      <button
        mat-menu-item
        id="editAssignmentsBtn-{{i}}"
        [routerLink]="['/plugins/backend-configuration-pn/task-worker-assignments/' + row.siteId]"
      >
        <mat-icon>visibility</mat-icon>
        <span>{{ 'Show assignments' | translate }}</span>
      </button>
      <button
        mat-menu-item
        *ngIf="selectCurrentUserClaimsDeviceUsersUpdate$ | async"
        id="editDeviceUserBtn-{{i}}"
        (click)="openEditModal(row)"
      >
        <mat-icon>edit</mat-icon>
        <span>{{ 'Edit Device User' | translate }}</span>
      </button>
      <button
        mat-menu-item
        color="warn"
        *ngIf="(selectCurrentUserClaimsDeviceUsersDelete$ | async) && !row.isLocked"
        id="deleteDeviceUserBtn-{{i}}"
        (click)="openDeleteDeviceUserModal(row)"
      >
        <mat-icon color="warn">delete</mat-icon>
        <span>{{ 'Delete Device User' | translate }}</span>
      </button>
    </mat-menu>
  </div>
</ng-template>


<ng-template #manufacturerTpl let-row>
  <ng-container *ngIf="row.osVersion !== null">
    <ng-container *ngIf="row['manufacturer'] === 'iOS' ">
      <div class="manufacturer" id="manufacturer-{{row.id}}">
                <span [matTooltip]="row['deviceModel']" class="neutral-icon">
                  <mat-icon>phone_iphone</mat-icon>
                </span>
        {{row.model}} ({{row.osVersion}})
      </div>
    </ng-container>
    <ng-container *ngIf="row['manufacturer'] === 'Android' ">
      <div class="manufacturer" id="manufacturer-{{row.id}}">
                <span [matTooltip]="row['deviceModel']" class="neutral-icon">
                  <mat-icon>android</mat-icon>
                </span>
        {{row.model}} ({{row.osVersion}})
      </div>
    </ng-container>
  </ng-container>
</ng-template>

<ng-template #taskManagementEnabledTpl let-row>
  <mat-chip
    [ngClass]="{
      'status-active': TaskWizardStatusesEnum[row.taskManagementEnabled ? 1 : 2] === 'Active',
      'status-inactive': TaskWizardStatusesEnum[row.taskManagementEnabled ? 1 : 2] !== 'Active'
    }"
  >
    <span title="{{TaskWizardStatusesEnum[row.taskManagementEnabled ? 1 : 2] | translate}}">{{TaskWizardStatusesEnum[row.taskManagementEnabled ? 1 : 2] | translate}}</span>
  </mat-chip>
</ng-template>

<ng-template #timeRegistrationEnabledTpl let-row>
  <mat-chip
    [ngClass]="{
      'status-active': TaskWizardStatusesEnum[row.timeRegistrationEnabled ? 1 : 2] === 'Active',
      'status-inactive': TaskWizardStatusesEnum[row.timeRegistrationEnabled ? 1 : 2] !== 'Active'
    }"
  >
    <span title="{{TaskWizardStatusesEnum[row.timeRegistrationEnabled ? 1 : 2] | translate}}">{{TaskWizardStatusesEnum[row.timeRegistrationEnabled ? 1 : 2] | translate}}</span>
  </mat-chip>
</ng-template>
